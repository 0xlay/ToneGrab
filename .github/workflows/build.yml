name: Build ToneGrab

permissions:
  contents: write

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows-x64:
    name: Build Windows (x64)
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Download FFmpeg
      run: |
        # Create ffmpeg directory structure
        New-Item -ItemType Directory -Force -Path ffmpeg/windows/bin
        
        # Download FFmpeg x64
        $ffmpegUrl = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip"
        Invoke-WebRequest -Uri $ffmpegUrl -OutFile ffmpeg-win.zip
        
        # Extract FFmpeg
        Expand-Archive -Path ffmpeg-win.zip -DestinationPath ffmpeg-temp
        
        # Copy binaries
        $ffmpegDir = Get-ChildItem -Path ffmpeg-temp -Filter "ffmpeg-*" -Directory | Select-Object -First 1
        Copy-Item "$($ffmpegDir.FullName)/bin/ffmpeg.exe" -Destination ffmpeg/windows/bin/
        Copy-Item "$($ffmpegDir.FullName)/bin/ffprobe.exe" -Destination ffmpeg/windows/bin/
        # Find LICENSE file (may be LICENSE.txt or LICENSE)
        $licenseFile = Get-ChildItem -Path $ffmpegDir.FullName -Filter "LICENSE*" | Select-Object -First 1
        Copy-Item $licenseFile.FullName -Destination ffmpeg/windows/LICENSE.txt
        
        # Cleanup
        Remove-Item -Recurse -Force ffmpeg-temp, ffmpeg-win.zip
      shell: pwsh
      
    - name: Build Windows executable
      run: python build/build_windows.py
      
    - name: Create Windows artifact
      run: |
        $version = if ($env:GITHUB_REF -match 'refs/tags/v(.*)') { $matches[1] } else { "dev" }
        New-Item -ItemType Directory -Force -Path artifacts
        Compress-Archive -Path dist/ToneGrab.exe -DestinationPath "artifacts/ToneGrab-windows-x64-$version.zip"
      shell: pwsh
      
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: ToneGrab-windows-x64
        path: artifacts/*.zip
        retention-days: 30

  build-windows-arm64:
    name: Build Windows (ARM64)
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Download FFmpeg
      run: |
        # Create ffmpeg directory structure
        New-Item -ItemType Directory -Force -Path ffmpeg/windows/bin
        
        # Download FFmpeg ARM64
        $ffmpegUrl = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-winarm64-gpl.zip"
        Invoke-WebRequest -Uri $ffmpegUrl -OutFile ffmpeg-win-arm64.zip
        
        # Extract FFmpeg
        Expand-Archive -Path ffmpeg-win-arm64.zip -DestinationPath ffmpeg-temp
        
        # Copy binaries
        $ffmpegDir = Get-ChildItem -Path ffmpeg-temp -Filter "ffmpeg-*" -Directory | Select-Object -First 1
        Copy-Item "$($ffmpegDir.FullName)/bin/ffmpeg.exe" -Destination ffmpeg/windows/bin/
        Copy-Item "$($ffmpegDir.FullName)/bin/ffprobe.exe" -Destination ffmpeg/windows/bin/
        # Find LICENSE file (may be LICENSE.txt or LICENSE)
        $licenseFile = Get-ChildItem -Path $ffmpegDir.FullName -Filter "LICENSE*" | Select-Object -First 1
        Copy-Item $licenseFile.FullName -Destination ffmpeg/windows/LICENSE.txt
        
        # Cleanup
        Remove-Item -Recurse -Force ffmpeg-temp, ffmpeg-win-arm64.zip
      shell: pwsh
      
    - name: Build Windows ARM64 executable
      run: python build/build_windows.py
      env:
        PYINSTALLER_TARGET_ARCH: arm64
      
    - name: Create Windows ARM64 artifact
      run: |
        $version = if ($env:GITHUB_REF -match 'refs/tags/v(.*)') { $matches[1] } else { "dev" }
        New-Item -ItemType Directory -Force -Path artifacts
        Compress-Archive -Path dist/ToneGrab.exe -DestinationPath "artifacts/ToneGrab-windows-arm64-$version.zip"
      shell: pwsh
      
    - name: Upload Windows ARM64 artifact
      uses: actions/upload-artifact@v4
      with:
        name: ToneGrab-windows-arm64
        path: artifacts/*.zip
        retention-days: 30

  build-linux:
    name: Build Linux (x64)
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libxcb-xinerama0 libxcb-cursor0 libxkbcommon-x11-0 \
          libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 \
          libxcb-shape0 libdbus-1-3 libgl1 libegl1 libxkbcommon0
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Download FFmpeg
      run: |
        # Create ffmpeg directory structure
        mkdir -p ffmpeg/linux/bin
        
        # Download FFmpeg static build
        wget https://johnvansickle.com/ffmpeg/builds/ffmpeg-git-amd64-static.tar.xz
        
        # Extract FFmpeg
        tar -xf ffmpeg-git-amd64-static.tar.xz
        
        # Copy binaries
        FFMPEG_DIR=$(find . -maxdepth 1 -type d -name "ffmpeg-git-*-amd64-static" | head -n 1)
        cp "$FFMPEG_DIR/ffmpeg" ffmpeg/linux/bin/
        cp "$FFMPEG_DIR/ffprobe" ffmpeg/linux/bin/
        cp "$FFMPEG_DIR/GPLv3.txt" ffmpeg/linux/LICENSE.txt
        
        # Make executable
        chmod +x ffmpeg/linux/bin/*
        
        # Cleanup
        rm -rf "$FFMPEG_DIR" ffmpeg-git-amd64-static.tar.xz
        
    - name: Build Linux executable
      run: python build/build_linux.py
      
    - name: Create Linux artifact
      run: |
        VERSION=$(echo $GITHUB_REF | sed -n 's/refs\/tags\/v\(.*\)/\1/p')
        VERSION=${VERSION:-dev}
        mkdir -p artifacts
        chmod +x dist/ToneGrab
        cd dist && zip ../artifacts/ToneGrab-linux-x64-$VERSION.zip ToneGrab
        
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: ToneGrab-linux-x64
        path: artifacts/*.zip
        retention-days: 30

  build-linux-arm64:
    name: Build Linux (ARM64)
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libxcb-xinerama0 libxcb-cursor0 libxkbcommon-x11-0 \
          libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 \
          libxcb-shape0 libdbus-1-3 libgl1 libegl1 libxkbcommon0
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Download FFmpeg ARM64
      run: |
        # Create ffmpeg directory structure
        mkdir -p ffmpeg/linux/bin
        
        # Download FFmpeg ARM64 static build
        wget https://johnvansickle.com/ffmpeg/builds/ffmpeg-git-arm64-static.tar.xz
        
        # Extract FFmpeg
        tar -xf ffmpeg-git-arm64-static.tar.xz
        
        # Copy binaries
        FFMPEG_DIR=$(find . -maxdepth 1 -type d -name "ffmpeg-git-*-arm64-static" | head -n 1)
        cp "$FFMPEG_DIR/ffmpeg" ffmpeg/linux/bin/
        cp "$FFMPEG_DIR/ffprobe" ffmpeg/linux/bin/
        cp "$FFMPEG_DIR/GPLv3.txt" ffmpeg/linux/LICENSE.txt
        
        # Make executable
        chmod +x ffmpeg/linux/bin/*
        
        # Cleanup
        rm -rf "$FFMPEG_DIR" ffmpeg-git-arm64-static.tar.xz
    
    - name: Build Linux ARM64 executable
      run: |
        # Note: This creates an x64 binary with ARM64 FFmpeg
        # For true ARM64 builds, use native ARM64 runners (not available in free tier)
        python build/build_linux.py
    
    - name: Create Linux ARM64 artifact
      run: |
        VERSION=$(echo $GITHUB_REF | sed -n 's/refs\/tags\/v\(.*\)/\1/p')
        VERSION=${VERSION:-dev}
        mkdir -p artifacts
        chmod +x dist/ToneGrab
        cd dist && zip ../artifacts/ToneGrab-linux-arm64-$VERSION.zip ToneGrab
    
    - name: Upload Linux ARM64 artifact
      uses: actions/upload-artifact@v4
      with:
        name: ToneGrab-linux-arm64
        path: artifacts/*.zip
        retention-days: 30

  build-macos-apple-silicon:
    name: Build macOS (Apple Silicon ARM64)
    runs-on: macos-latest  # M1/ARM runner
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller Pillow
        
    - name: Download FFmpeg
      run: |
        set -e  # Exit on error
        
        # Create ffmpeg directory structure
        mkdir -p ffmpeg/macos/bin
        
        # Check architecture
        echo "System architecture: $(uname -m)"
        
        # We need STATIC FFmpeg binaries (not Homebrew dynamic builds)
        # Homebrew ffmpeg has @rpath dependencies which won't work in bundled app
        
        echo "Attempting to download static FFmpeg builds..."
        
        # Try ffmpeg-static npm package first (known to work and be truly static)
        if npm install --no-save ffmpeg-static ffprobe-static 2>/dev/null; then
          echo "Successfully installed ffmpeg-static and ffprobe-static"
          
          # Find the binaries
          FFMPEG_BIN=$(find node_modules/ffmpeg-static -name ffmpeg -type f 2>/dev/null | head -n 1)
          FFPROBE_BIN=$(find node_modules/ffprobe-static -name ffprobe -type f 2>/dev/null | head -n 1)
          
          if [ -n "$FFMPEG_BIN" ] && [ -n "$FFPROBE_BIN" ]; then
            echo "Found binaries:"
            echo "  ffmpeg: $FFMPEG_BIN"
            echo "  ffprobe: $FFPROBE_BIN"
            
            # Copy to bundle
            cp "$FFMPEG_BIN" ffmpeg/macos/bin/ffmpeg
            cp "$FFPROBE_BIN" ffmpeg/macos/bin/ffprobe
            
            # Clean up node_modules
            rm -rf node_modules package-lock.json
          else
            echo "ERROR: Could not find binaries in npm packages"
            exit 1
          fi
        else
          echo "npm install failed, trying direct download from evermeet.cx..."
          
          # Create temp directory
          mkdir -p ffmpeg-temp
          cd ffmpeg-temp
          
          # Try evermeet.cx
          curl -L "https://evermeet.cx/ffmpeg/getrelease/ffmpeg/7z" -o ffmpeg.7z
          curl -L "https://evermeet.cx/ffmpeg/getrelease/ffprobe/7z" -o ffprobe.7z
          
          # Extract (try with 7z or fall back to built-in tools)
          if command -v 7z &> /dev/null; then
            7z x ffmpeg.7z
            7z x ffprobe.7z
          else
            # If no 7z, try downloading zip instead
            rm -f ffmpeg.7z ffprobe.7z
            curl -L "https://evermeet.cx/ffmpeg/getrelease/ffmpeg/zip" -o ffmpeg.zip
            curl -L "https://evermeet.cx/ffmpeg/getrelease/ffprobe/zip" -o ffprobe.zip
            unzip -o ffmpeg.zip
            unzip -o ffprobe.zip
          fi
          
          # Check if extracted
          if [ -f ffmpeg ] && [ -f ffprobe ]; then
            echo "Successfully extracted FFmpeg from evermeet.cx"
            cd ..
            mv ffmpeg-temp/ffmpeg ffmpeg/macos/bin/
            mv ffmpeg-temp/ffprobe ffmpeg/macos/bin/
            rm -rf ffmpeg-temp
          else
            echo "ERROR: Could not extract FFmpeg"
            cd ..
            rm -rf ffmpeg-temp
            exit 1
          fi
        fi
        
        # Make executable
        chmod +x ffmpeg/macos/bin/ffmpeg
        chmod +x ffmpeg/macos/bin/ffprobe
        
        # Verify architecture and dependencies
        echo ""
        echo "=== FFmpeg Verification ==="
        echo "Architecture:"
        file ffmpeg/macos/bin/ffmpeg
        file ffmpeg/macos/bin/ffprobe
        
        echo ""
        echo "Dependencies (first 15 lines):"
        otool -L ffmpeg/macos/bin/ffmpeg | head -n 15
        
        echo ""
        echo "Testing execution:"
        ffmpeg/macos/bin/ffmpeg -version 2>&1 | head -n 3
        
        # Create LICENSE file
        echo "FFmpeg static binaries" > ffmpeg/macos/LICENSE.txt
        echo "FFmpeg is licensed under LGPL/GPL" >> ffmpeg/macos/LICENSE.txt
        echo "https://ffmpeg.org/legal.html" >> ffmpeg/macos/LICENSE.txt
        
        echo ""
        echo "=== FFmpeg setup complete ==="
        
    - name: Build macOS application
      run: python build/build_macos.py
      
    - name: Create macOS artifact
      run: |
        VERSION=$(echo $GITHUB_REF | sed -n 's/refs\/tags\/v\(.*\)/\1/p')
        VERSION=${VERSION:-dev}
        mkdir -p artifacts
        cd dist && zip -r ../artifacts/ToneGrab-macos-apple-silicon-arm64-$VERSION.zip ToneGrab.app
        
    - name: Upload macOS Apple Silicon artifact
      uses: actions/upload-artifact@v4
      with:
        name: ToneGrab-macos-apple-silicon-arm64
        path: artifacts/*.zip
        retention-days: 30

  create-release:
    name: Create Release
    needs: [build-windows-x64, build-windows-arm64, build-linux, build-linux-arm64, build-macos-apple-silicon]
    runs-on: ubuntu-22.04
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Display artifact structure
      run: |
        echo "Artifact directory structure:"
        ls -R artifacts/
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/*/*.zip
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
